#!/usr/bin/ksh

DEBUG=0 ; [[ $DEBUG == *1* ]] && set -x		# set -x fuer das hauptprogramm ohne funktionen ...
FDEBUG=0 ; [[ $FDEBUG == *1* ]] && set -x	# set -x fuer funktionen ...
#dbg=""
dbg=echo
#
# 2step-netconfig
#
# (c)  www.pixel-bit.de, markus braun
#
# das script aendert die tcp/ip netzwerkkonfiguration eines suse rechners.
# die notwendigen angaben bezieht diese script aus der Datei aus $1
#
# (c) peter.krauspe@dfs.de  # Aenderungen 16.10.2015
#
# Modifiziert fuer rein lokale Verwendung mit vorhandener Datei 2step.vars als Kommandozeilenparameter
# 2step.vars muss mit 2step-get-infos erzeugt worden sein 


# main 

# global var ...

typeset fqdn=""						# fqdn aus $hn.$dn 
typeset hwaddr=""					# hardware address -> mac address ...
typeset hn=""						# ...
typeset sn=""						# ...
typeset -A FILE						# FILE array zum einlesen von dateiinhalten ...
typeset argc

if (( $# <= 0 )); then
  echo "\nusage: $(basename $0) <2step.vars file>\n"
  exit 1
fi

if [[ -f $1 ]]; then
  twostep_vars=$1
  source $twostep_vars
  # alle konfigurationswerte sind nun eingelesen 
else
  echo "$1 not found !!"
  exit
fi

# schreiben der konfiguration ... fuer alle netzwerkschnittstellen ...

for hn in ${HN[fqdn.list]}		# konfiguration fuer alle hn=... , in eingelesener reihenfolge !
do

	# interface device-file ermitteln
	#
	# mac-adresse ...
	#
	# cat /sys/class/net/eth0/address
	# 00:1a:6b:36:68:d0

	hwaddr=$(</sys/class/net/${HN[${hn}.dv]}/address 2>/dev/null)	# mac adresse lower-case

	if [[ -z ${hwaddr} ]]
	then
		die "interface: ${HN[${hn}.dv]} not exist, skip to next hostname/interface ..."
		continue				# naechster hn=...
	fi

	# device konfigdatei ermitteln und sourcen ...
	#
	f=$( echo /etc/sysconfig/network/ifcfg*${hwaddr} )
	[[ ! -f $f ]] && f=/etc/sysconfig/network/ifcfg-${HN[${hn}.dv]}

	if [[ ! -f $f ]]		# weder ifcfg-*<mac>, noch ifcfg-ethx vorhanden ...
	then

		die "prog:$0 : no ip-config-interface file found create it: $f ..."

		# konfigurationsdatei erstellen schreiben ...
		if [[ ${HN[${hn}.ip]} != 0.0.0.0 ]]
		then
			# dhcp ip ...
			cat <<-@ > $f
			BOOTPROTO='dhcp'
			STARTMODE='auto'
			UNIQUE=$RANDOM
			USERCONTROL='no'
			_type=eth
			BROADCAST=''
			IPADDR=''
			MTU=''
			@
		else
			# statuc ip ...
			cat <<-@ > $f
			BOOTPROTO='static'
			STARTMODE='auto'
			UNIQUE=$RANDOM
			USERCONTROL='no'
			_type=eth
			BROADCAST=''
			IPADDR=${HN[${hn}.ip]}
			MTU=1500
			NETMASK=${HN[${hn}.sn]}
			NETWORK=''
			@
		fi

	fi

	# konfiguration einlesen ...
	while read line
	do
		FILE["${line%%=*}"]="$line"
	done < ${f}

	# konfiguration aendern ...

	[[ ${FILE[_type]} == '' ]] && FILE[_type]='eth'

	if [[ ${HN[${hn}.ip]} == 0.0.0.0 ]]
	then 
		# dhcp ip ...
		for cfg in BOOTPROTO='dhcp' IPADDR=''  NETMASK=''  _type='eth' USERCONTROL='no'
		do
			FILE["${cfg%%=*}"]="${cfg}"
		done
	else
		# static ip ...
		for cfg in BOOTPROTO='static' IPADDR=${HN[${hn}.ip]} NETMASK=${HN[${hn}.sn]} _type='eth' USERCONTROL='no'
		do
			FILE["${cfg%%=*}"]="${cfg}"
		done
	fi

	# konfiguration schreiben ...

	( for line in ${!FILE[*]}
	  do
	  	echo ${FILE[${line}]}
  	  done  ) > ${f}

done

# hostnamen schreiben ...
[[ -n ${HN[fqdn]} ]] && echo "${fqdn}" > /etc/HOSTNAME || die "$0:$LINENO no hostname set ..."

# hostnamen in /etc/hosts eintragen ...
cat <<-EOF > /etc/hosts.2step
	#
	# hosts         This file describes a number of hostname-to-address
	#               
	# Syntax:
	#    
	# IP-Address  Full-Qualified-Hostname  Short-Hostname
	#
	# generated by 2step install system $( date '+%Y/%m/%d %H:%M:%S' )
	#
	127.0.0.1       localhost
	$( for fqdn in ${HN[fqdn.list]}
	   do
		fqdn=${fqdn%.}
		echo "${HN[${fqdn}.ip]}	${fqdn} ${HN[${fqdn}.hn]}"

		if [[ -n ${HN[${fqdn}.gw]} ]]
		then
			# 	defaultrouter.${HN[first.dn]} defaultrouter
			# 45.250.232.10.in-addr.arpa domain name pointer zempinpc.se.dfs.de.
			# Host 222.250.232.10.in-addr.arpa not found: 3(NXDOMAIN)
			set -- $( get_lookup ptr ${HN[${fqdn}.gw]} )
			if [[ $2 == hn=* ]]
			then
				hn=${2#*hn=}
				echo "${HN[${fqdn}.gw]}	${hn} ${hn%%.*}"
			fi
		fi 

	   done ) 
	EOF

cp /etc/hosts.2step /etc/hosts

# dns konfiguration ...
# dns konfiguration sichern ...
# todo nur bei network installation gibt es eine resolv.saved.by.dhcpcd.<net>
#      was ist bei einer nicht network installation ????

# dns konfiguration schreiben ...
( for hn in ${HN[fqdn.list]}		# konfiguration fuer alle hn=... , in eingelesener reihenfolge !
  do
	for dns in ${HN[${hn}.ns]//:/ }
	do
		echo nameserver $dns
	done
  done 
  [[ -n ${HN[dn]} ]] && echo "domain ${HN[dn]}" ) > /etc/resolv.conf

cp /etc/resolv.conf /etc/resolv.conf.saved.by.dhcpcd.${HN[install.interface]}
cp /etc/resolv.conf /etc/resolv.conf.2step

# routing konfiguration ....

# default router schreiben ...
# Change (PK) : default gateway tauch 2 mal auf, siehe unten, daher mal auskommentiert:

#( [[ -n ${HN[${HN[fqdn]}.gw]} ]] && echo "default ${HN[${HN[fqdn]}.gw]} - -" ) > /etc/sysconfig/network/routes

# statische routen eintragen ...

( for hn in  ${HN[fqdn.list]}
  do
	[[ -z ${HN[${hn}.rt]} ]] && continue	# alle config parameter des hosts ...
	

	# dv=eth0 rt=ip:sn:gw:dv;ip:sn:gw:dv --> gruppenwechsel mit ';'

	for rt in ${HN[$hn.rt]//\;/ }		# fuer jede statische route ...
	do

		set -- ${rt//:/ }

		dst=${rt%%:*}						# ip destination ...
		sn=${rt#*$dst:} ; sn=${sn%%:*}				# subnetmask ...
		gw=${rt#*$sn:} ; gw=${gw%%:*}				# default gateway ...
		dv=${rt#*$gw:} ; dv=${dv%%:*} ; [[ -z $dv ]] && dv='-'	# device/interface ...

		echo "$dst $gw $sn $dv"

	done
  done 
 
# default gateway ...
  for hn in  ${HN[fqdn.list]}
  do
	[[ -z ${HN[${hn}.gw]} ]] && continue	# kein default gateway ...
	echo "default ${HN[${hn}.gw]}  - - " 
	break
  done ) > /etc/sysconfig/network/routes 
